<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Service AC - Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f7fafc;
      }
      .form-group .icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
      }
      .form-group .form-input {
        padding-left: 3rem;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .quota-warning {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        border: 2px solid #e17055;
        color: #4a4a4a;
      }
      .quota-full {
        background: linear-gradient(135deg, #ff7675, #d63031);
        color: white;
      }
      .quota-available {
        background: linear-gradient(135deg, #00cec9, #00b894);
        color: white;
      }
      .info-box {
        transition: background-color 0.5s ease, color 0.5s ease,
          border-color 0.5s ease;
      }
      input:read-only {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.8;
      }

      /* Service section styles */
      .service-section {
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }
      .service-section.has-selection {
        border-color: #3b82f6;
        background-color: #eff6ff;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
      }
      .service-section.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .service-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      .service-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
      }
      .unit-counter {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 80px;
        text-align: center;
      }

      /* Quantity controls */
      .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
      }
      .quantity-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
        font-size: 1.2rem;
      }
      .quantity-btn:hover:not(.disabled) {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .quantity-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quantity-display {
        font-size: 1.5rem;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
        color: #374151;
      }

      /* Time slot styles */
      .time-option {
        padding: 1rem 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }
      .time-option:hover:not(.disabled) {
        border-color: #3b82f6;
        background-color: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .time-option.selected {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .time-option.disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
        border-color: #e5e7eb;
        opacity: 0.6;
      }

      /* Custom cluster input */
      .custom-cluster-input {
        margin-top: 0.75rem;
        display: none;
      }
      .custom-cluster-input.show {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Auto refresh indicator */
      .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .refresh-indicator.show {
        opacity: 1;
      }
    </style>
  </head>
  <body class="text-gray-700">
    <!-- Auto refresh indicator -->
    <div id="refreshIndicator" class="refresh-indicator">
      üîÑ Memperbarui data...
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
      <div
        class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden"
      >
        <div
          class="header bg-gradient-to-br from-gray-800 to-gray-900 text-white p-8 text-center"
        >
          <img
            src="https://i.pinimg.com/736x/b1/43/89/b14389bd28cbf08b8741f7084ce8ec0d.jpg"
            alt="Logo"
            class="w-16 h-16 mx-auto rounded-full mb-4 border-2 border-white shadow-md"
            onerror="this.onerror=null;this.src='https://placehold.co/64x64/e2e8f0/4a5568?text=AFC';"
          />
          <h1 class="text-2xl font-bold tracking-tight">Booking Layanan AC</h1>
          <p class="text-gray-300 text-sm mt-2"></p>
        </div>

        <div class="form-container p-8">
          <form id="bookingForm" name="submit-to-google-sheet">
            <div
              id="quotaInfo"
              class="info-box rounded-lg p-4 mb-6 text-center text-sm"
            >
              <p id="quotaMessage">Memuat informasi slot...</p>
              <div id="quotaStatus" class="mt-2 text-xs font-medium">
                Mohon tunggu...
              </div>
            </div>

            <div class="form-group relative mb-4">
              <label for="bookingId" class="block text-sm font-medium mb-1"
                >Booking ID</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
                  />
                  <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
                  <path d="M9 12h6" />
                </svg>
              </span>
              <input
                type="text"
                id="bookingId"
                name="bookingId"
                class="form-input w-full p-3 border border-gray-300 rounded-lg"
                readonly
                placeholder="Memuat Booking ID..."
              />
            </div>

            <div class="form-group relative mb-4">
              <label for="nama" class="block text-sm font-medium mb-1"
                >Nama Lengkap</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </span>
              <input
                type="text"
                id="nama"
                name="nama"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="name"
                placeholder="Masukan nama Anda"
              />
            </div>

            <div class="form-group relative mb-4">
              <label for="noHp" class="block text-sm font-medium mb-1"
                >No WhatsApp</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path>
                </svg>
              </span>
              <input
                type="tel"
                id="noHp"
                name="noHp"
                placeholder="awali dengan angka 62 ( contoh : 62812XXXXXXX)"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="tel"
              />
            </div>

            <div class="form-group relative mb-4">
              <label for="cluster" class="block text-sm font-medium mb-1"
                >Cluster / Lokasi</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                  ></path>
                  <polyline points="9,22 9,12 15,12 15,22"></polyline>
                </svg>
              </span>
              <select
                id="cluster"
                name="cluster"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              >
                <option value="">Pilih Cluster / Lokasi</option>
                <option value="Bahamas">Bahamas</option>
                <option value="Brazillia">Brazillia</option>
                <option value="Buenos Aires">Buenos Aires</option>
                <option value="Carribean Island">Carribean Island</option>
                <option value="Centro Havana">Centro Havana</option>
                <option value="Clio Vintage">Clio Vintage</option>
                <option value="Costa Rica">Costa Rica</option>
                <option value="De Rio">De Rio</option>
                <option value="La Vintage">La Vintage</option>
                <option value="Mexicano">Mexicano</option>
                <option value="Patagonia">Patagonia</option>
                <option value="Santiago">Santiago</option>
                <option value="The Virgin">The Virgin</option>
                <option value="Eksternal (Luar Latinos)">
                  Eksternal (Luar Latinos)
                </option>
              </select>

              <!-- Custom cluster input for external locations -->
              <div id="customClusterInput" class="custom-cluster-input">
                <input
                  type="text"
                  id="customCluster"
                  name="customCluster"
                  class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition"
                  placeholder="Ketik lokasi Anda (contoh: Perumahan ABC, Jl. XYZ)"
                />
                <p class="text-xs text-orange-600 mt-1">
                  üí° Mohon tulis alamat lengkap untuk memudahkan teknisi
                </p>
              </div>
            </div>

            <div class="form-group relative mb-4">
              <label for="alamat" class="block text-sm font-medium mb-1"
                >Alamat Lengkap</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </span>
              <textarea
                id="alamat"
                name="alamat"
                rows="3"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="street-address"
                placeholder="Contoh :  D4/13 atau alamat lengkap jika eksternal"
              ></textarea>
            </div>

            <div class="form-group mb-4">
              <label
                for="tanggalKunjungan"
                class="block text-sm font-medium mb-1"
                >Tanggal Kunjungan <span class="text-red-500">*</span></label
              >
              <input
                type="date"
                id="tanggalKunjungan"
                name="tanggalKunjungan"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                ‚ö†Ô∏è Wajib pilih tanggal untuk melihat slot tersedia
              </p>
            </div>

            <!-- Service Selection -->
            <div id="serviceSelection" class="mb-6">
              <label class="block text-sm font-medium mb-4"
                >Pilih Layanan <span class="text-red-500">*</span></label
              >
              <p class="text-xs text-gray-600 mb-4">
                üí° Total maksimal 10 unit AC per hari (gabungan cuci +
                perbaikan)
              </p>

              <!-- Cuci/Pemeriksaan AC Service -->
              <div id="cuciSection" class="service-section">
                <div class="service-header">
                  <h3 class="service-title">üßΩ Cuci / Pemeriksaan AC</h3>
                  <span
                    id="cuciCount"
                    class="unit-counter bg-blue-100 text-blue-800"
                    >0 unit</span
                  >
                </div>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn disabled"
                    id="cuciMinus"
                  >
                    ‚àí
                  </button>
                  <div class="quantity-display" id="cuciQuantity">0</div>
                  <button type="button" class="quantity-btn" id="cuciPlus">
                    +
                  </button>
                </div>
              </div>

              <!-- Perbaikan AC Service -->
              <div id="perbaikanSection" class="service-section">
                <div class="service-header">
                  <h3 class="service-title">üîß Perbaikan AC</h3>
                  <span
                    id="perbaikanCount"
                    class="unit-counter bg-green-100 text-green-800"
                    >0 unit</span
                  >
                </div>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn disabled"
                    id="perbaikanMinus"
                  >
                    ‚àí
                  </button>
                  <div class="quantity-display" id="perbaikanQuantity">0</div>
                  <button type="button" class="quantity-btn" id="perbaikanPlus">
                    +
                  </button>
                </div>
              </div>

              <!-- Total Units Display -->
              <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <div class="flex justify-between items-center">
                  <span class="font-medium text-gray-700">Total Unit AC:</span>
                  <span
                    id="totalUnitsDisplay"
                    class="font-bold text-lg text-blue-600"
                    >0 / 10</span
                  >
                </div>
              </div>
            </div>

            <!-- Time Selection -->
            <div id="timeSelection" class="mb-6">
              <label class="block text-sm font-medium mb-4"
                >Pilih Waktu Kunjungan
                <span class="text-red-500">*</span></label
              >

              <div
                class="time-option disabled"
                id="morningSlot"
                data-time="morning"
              >
                <div class="font-bold text-lg">üåÖ Pagi</div>
                <div class="text-sm text-gray-600 mt-1">08:00 - 11:30</div>
              </div>

              <div
                class="time-option disabled"
                id="afternoonSlot"
                data-time="afternoon"
              >
                <div class="font-bold text-lg">‚òÄÔ∏è Siang</div>
                <div class="text-sm text-gray-600 mt-1">13:00 - 16:30</div>
              </div>
            </div>

            <!-- Hidden inputs for form submission -->
            <input
              type="hidden"
              name="selectedServices"
              id="selectedServices"
              value=""
            />
            <input
              type="hidden"
              name="selectedTime"
              id="selectedTime"
              value=""
            />
            <input
              type="hidden"
              name="waktuKunjungan"
              id="waktuKunjungan"
              value=""
            />
            <input type="hidden" name="jumlahUnit" id="jumlahUnit" value="0" />

            <div class="form-group mb-6">
              <label for="catatan" class="block text-sm font-medium mb-1"
                >Catatan Khusus (Opsional)</label
              >
              <textarea
                id="catatan"
                name="catatan"
                rows="3"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Contoh : Saya bersedia reschedule kunjungan teknisi jika ada jadwal kosong lebih cepat"
              ></textarea>
            </div>

            <button
              type="submit"
              id="submitBtn"
              class="submit-btn w-full p-4 text-lg font-bold rounded-lg text-white shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 ease-in-out opacity-50 cursor-not-allowed"
              style="background-color: #ea4b16"
              disabled
            >
              Pilih Tanggal & Layanan Terlebih Dahulu
            </button>

            <div
              id="bookingWarning"
              class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
            >
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 text-yellow-400 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span
                  class="text-yellow-800 text-sm font-medium"
                  id="warningText"
                  >Perhatian!</span
                >
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modals remain the same -->
    <div
      id="loading-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-xl text-center">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-600">Memproses booking Anda...</p>
        <p class="text-sm text-gray-500 mt-2">
          Mengirim pesan WhatsApp otomatis...
        </p>
      </div>
    </div>

    <div
      id="success-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white p-8 rounded-xl text-center shadow-2xl max-w-sm w-full"
      >
        <div
          class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center text-green-500 text-4xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Booking Berhasil!</h3>
        <p class="text-gray-500 mb-4">
          Jadwal Anda telah kami catat dan pesan konfirmasi telah dikirim ke
          WhatsApp Anda secara otomatis.
        </p>

        <button
          class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition"
          onclick="closeFeedbackMessage()"
        >
          OK
        </button>
      </div>
    </div>

    <div
      id="error-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white p-8 rounded-xl text-center shadow-2xl max-w-sm w-full"
      >
        <div
          class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-4xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Terjadi Kesalahan</h3>
        <p id="error-message" class="text-gray-500 mb-4">Silakan coba lagi.</p>

        <button
          class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition"
          onclick="closeErrorModal()"
        >
          OK
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ===================================================
        // CONFIGURATION & VARIABLES
        // ===================================================
        const scriptURL =
          "https://script.google.com/macros/s/AKfycbx5a-YiiBYn-qDGL5Fskyw7Kphia8THRGEVbDq7u1g4bvF43h5ed8cWAram0uz8zmlk/exec";

        // DOM Elements
        const bookingForm = document.forms["submit-to-google-sheet"];
        const submitButton = document.getElementById("submitBtn");
        const tanggalKunjunganInput =
          document.getElementById("tanggalKunjungan");
        const bookingIdInput = document.getElementById("bookingId");
        const selectedServicesInput =
          document.getElementById("selectedServices");
        const selectedTimeInput = document.getElementById("selectedTime");
        const waktuKunjunganInput = document.getElementById("waktuKunjungan");
        const jumlahUnitInput = document.getElementById("jumlahUnit");
        const quotaStatus = document.getElementById("quotaStatus");
        const quotaMessage = document.getElementById("quotaMessage");
        const quotaInfo = document.getElementById("quotaInfo");
        const refreshIndicator = document.getElementById("refreshIndicator");
        const totalUnitsDisplay = document.getElementById("totalUnitsDisplay");

        // Cluster elements
        const clusterSelect = document.getElementById("cluster");
        const customClusterInput =
          document.getElementById("customClusterInput");
        const customClusterField = document.getElementById("customCluster");

        // Service elements
        const cuciSection = document.getElementById("cuciSection");
        const perbaikanSection = document.getElementById("perbaikanSection");
        const cuciCount = document.getElementById("cuciCount");
        const perbaikanCount = document.getElementById("perbaikanCount");
        const cuciQuantity = document.getElementById("cuciQuantity");
        const perbaikanQuantity = document.getElementById("perbaikanQuantity");

        // Quantity buttons
        const cuciPlus = document.getElementById("cuciPlus");
        const cuciMinus = document.getElementById("cuciMinus");
        const perbaikanPlus = document.getElementById("perbaikanPlus");
        const perbaikanMinus = document.getElementById("perbaikanMinus");

        // Time slots
        const morningSlot = document.getElementById("morningSlot");
        const afternoonSlot = document.getElementById("afternoonSlot");

        // Modals
        const loadingModal = document.getElementById("loading-modal");
        const successModal = document.getElementById("success-modal");
        const errorModal = document.getElementById("error-modal");
        const bookingWarning = document.getElementById("bookingWarning");

        // State management
        let serviceQuantities = {
          cuci: 0,
          perbaikan: 0,
        };
        let selectedTime = "";
        let dailyQuota = {}; // Will store daily quota information from server
        let autoRefreshInterval;

        // ===================================================
        // AUTO REFRESH FUNCTIONALITY
        // ===================================================

        function showRefreshIndicator() {
          refreshIndicator.classList.add("show");
          setTimeout(() => {
            refreshIndicator.classList.remove("show");
          }, 2000);
        }

        function startAutoRefresh() {
          // Refresh every 30 seconds
          autoRefreshInterval = setInterval(async () => {
            showRefreshIndicator();
            await fetchInitialData(false); // Silent refresh
            updateDateDisplay();
          }, 30000);
        }

        function stopAutoRefresh() {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
          }
        }

        // ===================================================
        // CLUSTER MANAGEMENT
        // ===================================================

        clusterSelect.addEventListener("change", function () {
          if (this.value === "Eksternal (Luar Latinos)") {
            customClusterInput.classList.add("show");
            customClusterField.required = true;
            customClusterField.focus();
          } else {
            customClusterInput.classList.remove("show");
            customClusterField.required = false;
            customClusterField.value = "";
          }
        });

        // ===================================================
        // QUANTITY MANAGEMENT FUNCTIONS (FIXED LOGIC)
        // ===================================================

        function updateQuantity(serviceType, change) {
          const currentQty = serviceQuantities[serviceType];
          const otherServiceType =
            serviceType === "cuci" ? "perbaikan" : "cuci";
          const otherQty = serviceQuantities[otherServiceType];
          const currentTotal = currentQty + otherQty;

          let newQty = currentQty + change;

          // Ensure quantity doesn't go below 0
          if (newQty < 0) {
            newQty = 0;
          }

          // Ensure total doesn't exceed 10
          const newTotal = newQty + otherQty;
          if (newTotal > 10) {
            newQty = 10 - otherQty; // Adjust to fit within limit
          }

          serviceQuantities[serviceType] = newQty;

          // Update display
          document.getElementById(`${serviceType}Quantity`).textContent =
            newQty;
          document.getElementById(
            `${serviceType}Count`
          ).textContent = `${newQty} unit`;

          // Update section styling
          const section = document.getElementById(`${serviceType}Section`);
          section.classList.toggle("has-selection", newQty > 0);

          // Update button states
          updateQuantityButtons();
          updateTotalUnits();
          validateBooking();
        }

        function updateQuantityButtons() {
          const totalUnits =
            serviceQuantities.cuci + serviceQuantities.perbaikan;

          // Update minus buttons
          cuciMinus.classList.toggle("disabled", serviceQuantities.cuci === 0);
          perbaikanMinus.classList.toggle(
            "disabled",
            serviceQuantities.perbaikan === 0
          );

          // Update plus buttons - disable if total would exceed 10
          cuciPlus.classList.toggle("disabled", totalUnits >= 10);
          perbaikanPlus.classList.toggle("disabled", totalUnits >= 10);
        }

        function updateTotalUnits() {
          const totalUnits =
            serviceQuantities.cuci + serviceQuantities.perbaikan;
          jumlahUnitInput.value = totalUnits;
          totalUnitsDisplay.textContent = `${totalUnits} / 10`;

          // Update color based on total
          if (totalUnits === 0) {
            totalUnitsDisplay.className = "font-bold text-lg text-gray-400";
          } else if (totalUnits >= 8) {
            totalUnitsDisplay.className = "font-bold text-lg text-red-600";
          } else if (totalUnits >= 5) {
            totalUnitsDisplay.className = "font-bold text-lg text-yellow-600";
          } else {
            totalUnitsDisplay.className = "font-bold text-lg text-blue-600";
          }

          // Update hidden input with service data
          const serviceData = {
            cuci: serviceQuantities.cuci,
            perbaikan: serviceQuantities.perbaikan,
          };
          selectedServicesInput.value = JSON.stringify(serviceData);
        }

        // ===================================================
        // TIME SELECTION FUNCTIONS
        // ===================================================

        function selectTimeSlot(timeSlot) {
          if (timeSlot.classList.contains("disabled")) {
            return;
          }

          // Remove selection from all slots
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");

          // Add selection to clicked slot
          timeSlot.classList.add("selected");
          selectedTime = timeSlot.dataset.time;
          selectedTimeInput.value = selectedTime;

          // Update waktu kunjungan for spreadsheet
          const timeText =
            selectedTime === "morning"
              ? "Pagi (08:00-11:30)"
              : "Siang (13:00-16:30)";
          waktuKunjunganInput.value = timeText;

          validateBooking();
        }

        function enableTimeSlots() {
          morningSlot.classList.remove("disabled");
          afternoonSlot.classList.remove("disabled");
        }

        function disableTimeSlots() {
          morningSlot.classList.add("disabled");
          afternoonSlot.classList.add("disabled");
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");
          selectedTime = "";
          selectedTimeInput.value = "";
          waktuKunjunganInput.value = "";
        }

        // ===================================================
        // VALIDATION FUNCTIONS (ENHANCED)
        // ===================================================

        function validateBooking() {
          const visitDate = tanggalKunjunganInput.value;
          const totalUnits = parseInt(jumlahUnitInput.value) || 0;

          // Reset button state
          submitButton.disabled = true;
          submitButton.classList.add("opacity-50", "cursor-not-allowed");

          if (!visitDate) {
            submitButton.textContent =
              "Pilih Tanggal Kunjungan Terlebih Dahulu";
            disableTimeSlots();
            return;
          }

          // Enable time slots when date is selected
          enableTimeSlots();

          // Check if date is full
          const quota = dailyQuota[visitDate];
          if (quota && quota.totalBooked >= quota.maxCapacity) {
            submitButton.textContent = "Jadwal Penuh - Pilih Tanggal Lain";
            return;
          }

          if (totalUnits === 0) {
            submitButton.textContent = "Pilih Minimal 1 Layanan";
            return;
          }

          if (!selectedTime) {
            submitButton.textContent = "Pilih Waktu Kunjungan";
            return;
          }

          // Check if booking would exceed daily capacity
          const currentBooked = quota ? quota.totalBooked : 0;
          if (currentBooked + totalUnits > 10) {
            const available = 10 - currentBooked;
            submitButton.textContent = `Hanya tersisa ${available} slot - Kurangi jumlah unit`;
            showBookingWarning(
              `Tanggal ini hanya tersisa ${available} slot. Silakan kurangi jumlah unit atau pilih tanggal lain.`
            );
            return;
          }

          // All validations passed
          submitButton.disabled = false;
          submitButton.classList.remove("opacity-50", "cursor-not-allowed");
          submitButton.textContent = "Booking Sekarang";
          bookingWarning.classList.add("hidden");
        }

        function showBookingWarning(message) {
          document.getElementById("warningText").textContent = message;
          bookingWarning.classList.remove("hidden");
        }

        // ===================================================
        // DATA FETCHING FUNCTIONS (ENHANCED)
        // ===================================================

        async function fetchInitialData(showLoading = true) {
          if (showLoading) {
            quotaStatus.innerHTML = "Memuat data...";
            bookingIdInput.value = "Memuat...";
          }

          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            const response = await fetch(
              `${scriptURL}?action=getInitialData&t=${Date.now()}`,
              { 
                signal: controller.signal,
                mode: 'cors',
                headers: {
                  'Content-Type': 'application/json',
                }
              }
            );
            
            clearTimeout(timeoutId);
            
            if (!response.ok)
              throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            console.log("Received data:", data); // Debug log

            if (data.status === "success") {
              dailyQuota = data.dailyQuota || {}; // Get daily quota from server
              if (showLoading) {
                bookingIdInput.value = data.nextBookingId;
              }

              console.log("Daily quota updated:", dailyQuota); // Debug log

              // Check if we were in offline mode and now restored
              const offlineNotice = document.getElementById('offline-notice');
              if (offlineNotice) {
                offlineNotice.remove();
                showConnectionRestoredNotice();
              }

              // Update display immediately if date is already selected
              if (tanggalKunjunganInput.value) {
                updateDateDisplay();
              } else {
                quotaStatus.innerHTML =
                  "Pilih tanggal untuk melihat slot waktu";
                quotaMessage.innerHTML =
                  "Pilih tanggal kunjungan untuk melihat ketersediaan slot";
                quotaInfo.className =
                  "info-box rounded-lg p-4 mb-6 text-center text-sm";
              }
            } else {
              throw new Error(data.message || "Gagal memuat data.");
            }
          } catch (error) {
            console.error("Gagal mengambil data awal:", error);
            
            // Use fallback data when server is not available
            const fallbackData = generateFallbackData();
            
            if (showLoading) {
              if (error.name === 'AbortError') {
                quotaStatus.innerHTML = 
                  '<span class="text-yellow-500">Koneksi lambat - Menggunakan mode offline</span>';
              } else {
                quotaStatus.innerHTML =
                  '<span class="text-yellow-500">Server tidak tersedia - Mode offline aktif</span>';
              }
              
              bookingIdInput.value = fallbackData.nextBookingId;
              dailyQuota = fallbackData.dailyQuota;
              
              // Show offline notice
              showOfflineNotice();
              
              // Retry after 15 seconds in background
              setTimeout(() => {
                fetchInitialData(false); // Silent retry
              }, 15000);
            }
          }
        }

        function generateFallbackData() {
          // Generate a booking ID based on timestamp
          const now = new Date();
          const bookingId = `AFC${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
          
          // Create fallback quota data (assuming 15 slots per day)
          const fallbackQuota = {};
          for (let i = 0; i < 30; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            fallbackQuota[dateStr] = Math.floor(Math.random() * 15) + 5; // Random available slots
          }
          
          return {
            nextBookingId: bookingId,
            dailyQuota: fallbackQuota
          };
        }

        function showOfflineNotice() {
          const notice = document.createElement('div');
          notice.id = 'offline-notice';
          notice.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          notice.innerHTML = `
            <div class="flex items-center space-x-2">
              <span>‚ö†Ô∏è</span>
              <span>Mode Offline - Data mungkin tidak terbaru</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">&times;</button>
            </div>
          `;
          
          // Remove existing notice if any
          const existing = document.getElementById('offline-notice');
          if (existing) existing.remove();
          
          document.body.appendChild(notice);
          
          // Auto remove after 10 seconds
          setTimeout(() => {
            if (document.getElementById('offline-notice')) {
              notice.remove();
            }
          }, 10000);
        }

        function updateDateDisplay() {
          const visitDate = tanggalKunjunganInput.value;
          if (!visitDate) {
            quotaMessage.innerHTML =
              "Pilih tanggal kunjungan untuk melihat ketersediaan slot";
            quotaStatus.innerHTML = "Pilih tanggal untuk melihat slot waktu";
            quotaInfo.className =
              "info-box rounded-lg p-4 mb-6 text-center text-sm";
            disableTimeSlots();
            validateBooking();
            return;
          }

          try {
            const dateObj = new Date(visitDate + "T00:00:00");
            const formattedDate = dateObj.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            // Check quota for this date
            const quota = dailyQuota[visitDate];
            console.log(`Quota for ${visitDate}:`, quota); // Debug log

            if (quota) {
              const available = quota.maxCapacity - quota.totalBooked;

              if (available <= 0) {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = "üî¥ Jadwal penuh";
                quotaInfo.className =
                  "info-box quota-full rounded-lg p-4 mb-6 text-center text-sm";
                disableTimeSlots();
              } else if (available <= 2) {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = `‚ö†Ô∏è Sisa ${available} slot (hampir penuh)`;
                quotaInfo.className =
                  "info-box quota-warning rounded-lg p-4 mb-6 text-center text-sm";
                enableTimeSlots();
              } else {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = `‚úÖ Tersedia ${available} slot`;
                quotaInfo.className =
                  "info-box quota-available rounded-lg p-4 mb-6 text-center text-sm";
                enableTimeSlots();
              }
            } else {
              quotaMessage.innerHTML = `Slot waktu tersedia pada <strong>${formattedDate}</strong>`;
              quotaStatus.innerHTML = "‚úÖ Tersedia 10 slot";
              quotaInfo.className =
                "info-box quota-available rounded-lg p-4 mb-6 text-center text-sm";
              enableTimeSlots();
            }
          } catch (e) {
            console.error("Date parsing error:", e);
            quotaMessage.innerHTML = "Error parsing tanggal";
            disableTimeSlots();
          }

          validateBooking();
        }

        // ===================================================
        // EVENT LISTENERS (ENHANCED)
        // ===================================================

        // Quantity button listeners with improved logic
        cuciPlus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!cuciPlus.classList.contains("disabled")) {
            updateQuantity("cuci", 1);
          }
        });

        cuciMinus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!cuciMinus.classList.contains("disabled")) {
            updateQuantity("cuci", -1);
          }
        });

        perbaikanPlus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!perbaikanPlus.classList.contains("disabled")) {
            updateQuantity("perbaikan", 1);
          }
        });

        perbaikanMinus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!perbaikanMinus.classList.contains("disabled")) {
            updateQuantity("perbaikan", -1);
          }
        });

        // Time slot listeners
        morningSlot.addEventListener("click", () =>
          selectTimeSlot(morningSlot)
        );
        afternoonSlot.addEventListener("click", () =>
          selectTimeSlot(afternoonSlot)
        );

        // Date change listeners with immediate update
        tanggalKunjunganInput.addEventListener("input", function (e) {
          const selectedDateString = e.target.value;

          // Check for Sunday in 2025
          if (selectedDateString.startsWith("2025")) {
            const selectedDate = new Date(selectedDateString + "T00:00:00");
            if (selectedDate.getDay() === 0) {
              // Sunday
              alert(
                "Mohon maaf, kami tidak melayani booking pada hari Minggu di tahun 2025. Silakan pilih hari lain."
              );
              e.target.value = "";
              updateDateDisplay();
              return;
            }
          }

          // Clear time selection when date changes
          selectedTime = "";
          selectedTimeInput.value = "";
          waktuKunjunganInput.value = "";
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");

          updateDateDisplay();
        });

        tanggalKunjunganInput.addEventListener("change", updateDateDisplay);

        // ===================================================
        // FORM SUBMISSION (ENHANCED)
        // ===================================================

        bookingForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const visitDate = tanggalKunjunganInput.value;
          const totalUnits = parseInt(jumlahUnitInput.value);

          // Enhanced validation before submission
          if (!visitDate) {
            showError("Mohon pilih tanggal kunjungan terlebih dahulu.");
            return;
          }

          if (totalUnits < 1) {
            showError("Mohon pilih minimal 1 layanan.");
            return;
          }

          if (!selectedTime) {
            showError("Mohon pilih waktu kunjungan.");
            return;
          }

          if (!bookingForm.checkValidity()) {
            showError("Mohon lengkapi semua data yang diperlukan.");
            return;
          }

          // Check quota before submission
          const quota = dailyQuota[visitDate];
          const currentBooked = quota ? quota.totalBooked : 0;
          if (currentBooked + totalUnits > 10) {
            const available = 10 - currentBooked;
            showError(
              `Maaf, tanggal ini hanya tersisa ${available} slot. Silakan kurangi jumlah unit atau pilih tanggal lain.`
            );
            return;
          }

          showFeedback("loading");
          submitButton.disabled = true;

          try {
            const formData = new FormData(bookingForm);

            // Handle cluster data
            let clusterValue = clusterSelect.value;
            if (
              clusterValue === "Eksternal (Luar Latinos)" &&
              customClusterField.value.trim()
            ) {
              clusterValue = `Eksternal: ${customClusterField.value.trim()}`;
            }
            formData.set("cluster", clusterValue);

            const response = await fetch(scriptURL, {
              method: "POST",
              body: formData,
            });
            const result = await response.json();

            if (result.status === "success") {
              // Create service details for WhatsApp message
              let serviceDetails = [];
              if (serviceQuantities.cuci > 0) {
                serviceDetails.push(
                  `Cuci/Pemeriksaan AC: ${serviceQuantities.cuci} unit`
                );
              }
              if (serviceQuantities.perbaikan > 0) {
                serviceDetails.push(
                  `Perbaikan AC: ${serviceQuantities.perbaikan} unit`
                );
              }

              const timeText =
                selectedTime === "morning"
                  ? "Pagi (08:00 - 11:30)"
                  : "Siang (13:00 - 16:30)";
              serviceDetails.push(`Waktu: ${timeText}`);

              await sendWhatsAppMessage(
                document.getElementById("noHp").value,
                document.getElementById("nama").value,
                visitDate,
                totalUnits,
                document.getElementById("alamat").value,
                document.getElementById("bookingId").value,
                serviceDetails.join("\n"),
                clusterValue
              );

              // Refresh data after successful booking
              await fetchInitialData(false);
              showFeedback("success");
            } else {
              throw new Error(
                result.message || "Gagal mengirim data ke server"
              );
            }
          } catch (error) {
            console.error("Error!", error.message);
            showError(
              "Terjadi kesalahan saat mengirim data. Silakan coba lagi."
            );
          }
        });

        // ===================================================
        // WHATSAPP INTEGRATION
        // ===================================================

        async function sendWhatsAppMessage(
          phoneNumber,
          customerName,
          visitDate,
          unitCount,
          address,
          bookingId,
          serviceDetails,
          cluster
        ) {
          try {
            let formattedPhone = phoneNumber.replace(/^0+/, "62");
            if (!formattedPhone.startsWith("62")) {
              formattedPhone = "62" + formattedPhone;
            }

            const dateObj = new Date(visitDate + "T00:00:00");
            const formattedDate = dateObj.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            const clusterInfo = cluster ? `\nüèòÔ∏è *Lokasi:* ${cluster}` : "";

            const customerMessage = `üìã KONFIRMASI BOOKING SERVICE AC

*Booking ID: ${bookingId}*

Halo Bpk/Ibu *${customerName}*! üëã 

Booking layanan AC Anda telah berhasil dicatat:

üìÖ *Tanggal Kunjungan:* ${formattedDate}${clusterInfo}
üè† *Alamat:* ${address}

üõ†Ô∏è *Detail Layanan:*
${serviceDetails}

‚ùÑÔ∏è *Total Unit AC: ${unitCount} unit*

‚úÖ Teknisi kami akan melakukan kunjungan sesuai jadwal di atas.

Jika ada pertanyaan atau perlu mengubah jadwal, silakan hubungi kami.

*AQSHA FRESH & COOL*
_Layanan AC Profesional De Latinos & Sekitarnya_`;

            const response = await fetch(
              "https://crm.woo-wa.com/send/message-text",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  device_id: "d_ID@6753a3309becd_lLMQ0PrnAMfGf",
                  number: formattedPhone,
                  message: customerMessage,
                }),
              }
            );

            return response.ok;
          } catch (error) {
            console.error("Error mengirim WhatsApp:", error);
            return false;
          }
        }

        // ===================================================
        // UI HELPER FUNCTIONS
        // ===================================================

        function showFeedback(type) {
          // Hide all modals
          loadingModal.classList.add("hidden");
          successModal.classList.add("hidden");
          errorModal.classList.add("hidden");

          // Show specific modal
          if (type === "loading") loadingModal.classList.remove("hidden");
          else if (type === "success") successModal.classList.remove("hidden");
        }

        function showError(message) {
          document.getElementById("error-message").textContent = message;
          errorModal.classList.remove("hidden");
        }

        window.closeFeedbackMessage = function () {
          showFeedback("close");
          stopAutoRefresh();
          window.location.href = window.location.href.split("?")[0];
        };

        window.closeErrorModal = function () {
          errorModal.classList.add("hidden");
          submitButton.disabled = false;
        };

        function setMinVisitDate() {
          const today = new Date();
          const offset = today.getTimezoneOffset();
          const todayLocal = new Date(today.getTime() - offset * 60 * 1000);
          const todayString = todayLocal.toISOString().split("T")[0];

          tanggalKunjunganInput.min = todayString;

          // Auto-set today's date and immediately update display
          if (!tanggalKunjunganInput.value) {
            tanggalKunjunganInput.value = todayString;
            // Trigger immediate update
            setTimeout(() => {
              updateDateDisplay();
            }, 100);
          }
        }

        // ===================================================
        // PAGE VISIBILITY API FOR AUTO REFRESH
        // ===================================================

        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            stopAutoRefresh();
          } else {
            // Page became visible again, refresh data
            fetchInitialData(false);
            startAutoRefresh();
          }
        });

        // ===================================================
        // INITIALIZATION (ENHANCED)
        // ===================================================

        async function initializePage() {
          console.log("Initializing booking system...");

          // Set minimum date and auto-select today
          setMinVisitDate();

          // Initialize quantities and buttons
          updateQuantityButtons();
          updateTotalUnits();

          // Fetch initial data
          await fetchInitialData(true);

          // Update display if date is already set
          if (tanggalKunjunganInput.value) {
            updateDateDisplay();
          }

          // Start auto refresh
          startAutoRefresh();

          console.log("Booking system initialized successfully");
        }

        // Connection status checker
        async function checkServerConnection() {
          try {
            const response = await fetch(`${scriptURL}?action=ping&t=${Date.now()}`, {
              method: 'GET',
              mode: 'cors',
              signal: AbortSignal.timeout(5000)
            });
            return response.ok;
          } catch (error) {
            return false;
          }
        }

        // Show connection restored notice
        function showConnectionRestoredNotice() {
          const notice = document.createElement('div');
          notice.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          notice.innerHTML = `
            <div class="flex items-center space-x-2">
              <span>‚úÖ</span>
              <span>Koneksi server pulih - Data telah diperbarui</span>
            </div>
          `;
          
          document.body.appendChild(notice);
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            if (notice.parentNode) {
              notice.remove();
            }
          }, 5000);
        }

        // Initialize the page
        initializePage();

        // Handle page unload
        window.addEventListener("beforeunload", function () {
          stopAutoRefresh();
        });
      });
    </script>
  </body>
</html>
